parameters:
  - name: shouldGetTemplatesFromConfig
    displayName: shouldGetTemplatesFromConfig
    type: boolean
    default: false

trigger:
  branches:
    include:
      - develop
      - master/*
      - release/*
      - testprbuild/*
  paths:
    exclude:
      - .pipelines/*

variables:
  - template: ../variables/common.yml
  - name: outputDirectory
    value: "$(Pipeline.Workspace)/packagesDirectory"
  - name: shouldGetTemplatesFromConfig
    value: ${{ parameters.shouldGetTemplatesFromConfig }}

pool:
  vmImage: 'windows-latest'

jobs:
  - job: Build
    steps:
    - task: NuGetToolInstaller@1
      displayName: "Install nuget"

    - task: PowerShell@2
      inputs:
        targetType: 'filePath'
        filePath: $(System.DefaultWorkingDirectory)\.pipelines\azure-pipelines\DecideTemplatesToPack.ps1
        arguments:
          -outputDirectory '${{ variables.outputDirectory }}'
          -commitHash $(Build.SourceVersion)
          -shouldGetTemplatesFromConfig $$(shouldGetTemplatesFromConfig)
      env:
        BUILD_REASON: $(Build.Reason)
        SYSTEM_PULLREQUEST_SOURCEBRANCH: $(System.PullRequest.SourceBranch)
        SYSTEM_PULLREQUEST_TARGETBRANCH: $(System.PullRequest.TargetBranch)
      displayName: "Pack modified templates"

    - task: PublishBuildArtifacts@1
      displayName: "Upload Artifacts"
      inputs:
        PathtoPublish: '${{ variables.outputDirectory }}'
        ArtifactName: 'Packages'
